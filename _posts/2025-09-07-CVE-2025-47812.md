---
layout: post
title: "CVE-2025-47812, attack chain giúp stealth siêu cấp vũ trụ"
categories: Pentest
tags: [redteam, devops, OS, PE, system, blueteam, immediately]
---

# Mờ đầu
Khá lâu rồi mình mới lên một bài blog kĩ thuật, đây là quá trình tự mình nghiên cứu đồng thời học hỏi và tiếp thu kiến thức của đàn anh trong khoảng thời gian vừa rồi. Bài viết sẽ là cách chain CVE-2025-47812 với kĩ thuật Pre OS loading giúp cho attacker sau khi khai thác thành công sẽ stealth trên máy nạn nhân. Mặc dù vẫn còn nhiều hạn chế trong việc khiến người dùng (ở đây là server) trigger file độc hại nhưng vẫn sẽ là một cách để mọi người mở rộng kiến thức
![malware here](/images/cve-2025-47812/malware_here.jpg)

# Thân bài
### Tổng quan
Wing FTP Server là một phần mềm máy chủ chạy trên nhiều nền tảng hệ điều hành khác nhau: Linux, Window, MacOS được phát triển để truyền file với nhiều protocols như: FTP, SSH, SFTP, HTTP, HTTPS,... Phần mềm này được sử dụng rộng rãi trong các doanh nghiệp, trong mạng nội bộ lẫn bên ngoài Internet.

![banner](/images/cve-2025-47812/banner_wingftp.jpg)

Ngày 30/06/2025, [bài viết](https://www.rcesecurity.com/2025/06/what-the-null-wing-ftp-server-rce-cve-2025-47812) về lỗ hổng này được công bố và chỉ 1 ngày sau đó đã ghi nhận cuộc tấn bởi [huntress](https://www.huntress.com/blog/wing-ftp-server-remote-code-execution-cve-2025-47812-exploited-in-wild). Thông tin về lỗi được mô tả như sau:

![banner](/images/cve-2025-47812/sumary.jpg)
**Các điểm cần lưu ý**
+ CVE này có điểm CVSS là 10.0: Đây là điểm rất cao vì bề mặt tấn công và độ phức tạp rất dễ để khai thác và không yêu cầu bất kì tương tác nào của người dùng
+ CVE xảy ra trên máy chủ Wing FTP Server trước bản 7.4.4: Từ bản 7.4.3 trở xuống đã có thể bị tấn công
+ Lỗ hổng xảy ra trong quá trình xử lý `nullbyte` tại giao diện đăng nhập của admin và user cho phép RCE
+ Lỗ hổng còn cho phép leo thang đặc quyền (Administrator với Windows, root với Linux, mình chưa test trên MacOS) do chạy mặc định với quyền cao.
+ Vẫn cần tài khoản người dùng nhưng nếu có người dùng anonymous, cuộc tấn công sẽ xảy ra ở dạng Unauthenticated,
### Phân tích kĩ thuật

**1. Dựng môi trường phân tích**

Dựa vào những dữ kiện đã biết, thiết lập lab sẽ gồm.
+ [Windows Server 2022](https://archive.org/details/windows-server-2022) : Môi trường test
+ [Wing FTP Server 7.4.3](https://drive.google.com/file/d/1Hy-OAUSO4MKcOIkfZhfnyApV8RZmGtLP/view?usp=sharing): bản lỗi
+ [Visual Studio Code](https://drive.google.com/file/d/1Hy-OAUSO4MKcOIkfZhfnyApV8RZmGtLP/view?usp=sharing) : kiểm tra mã nguồn
+ [x64dbg]() : phân tích động
+ [IDA Pro]() : phân tích tĩnh
Sau khi cài đặt xong thì tạo 1 user là anonymous
![banner](/images/cve-2025-47812/anonymous.jpg)

**2. Phân tích lỗ hổng**

Quan sát hành vi thấy rằng khi người dùng đăng nhập sẽ tạo 1 yêu cầu POST với các tham số username=&password= tại endpoint /loginok.html. Người dùng đăng nhập thành công thì server sẽ sinh ra cookie với UID là một chuỗi ngẫu nhiên và tạo 1 file với filename là <UID>.lua tại folder session

![banner](/images/cve-2025-47812/normal1.jpg)
![banner](/images/cve-2025-47812/normal2.jpg)

Mình sẽ kiểm tra trong file loginok.html này nó đang làm gì. Dòng 16-20 sẽ nhận input của mình nhập vào bởi tham số tương ứng qua các phương thức GET/POST, sau khi nhận sẽ đến dòng 35 sẽ check tài khoản có hợp lệ không.
![banner](/images/cve-2025-47812/normal3.jpg)

Nếu tài khoản hợp lệ nó tiếp tục thực hiện và đi xuống dòng 64 để set vào table _SESSION với key là username và value là input được người dùng nhập. Tại đây có thể thấy input người dùng đã được truyền trực tiếp vào _SESSION mà không có biện pháp filter hay validate nào cả. Tiếp theo là đến dòng 76 và gọi SessionModule.save() với đối số là _SESSION_ID
![banner](/images/cve-2025-47812/normal4.jpg)

Đi vào file SessionModule.lua, ta thấy hàm save(id) nhận giá trị là UID được tạo, nó sẽ dùng UID để tạo 1 file là <UID>.lua trong folder Session và gọi hàm serialize() với tham số là SESSION do ta kiểm soát và một hàm write để ghi vào file <UID>.lua
![banner](/images/cve-2025-47812/normal5.jpg)

Tại hàm serialize() ta thấy nó đang lọc qua từng key và value và ghi vào file bằng cách cộng chuỗi. Chúng ta có thể kiểm soát được nội dung trong SESSION thì hoàn toàn có thể ghi vào file này
![banner](/images/cve-2025-47812/normal6.jpg)

Luồng thực thi mình sẽ tóm tắt như sau:
username qua methods GET hoặc POST -> hàm c_CheckUser() kiểm tra thông tin -> rawset() -> SessionModule.save() -> serialize()

Tuy nhiên lỗi này xảy ra do quá trình xử lý nullbyte không đúng, server sẽ check phần trước nullbyte tại tham số username, nếu tài khoản hợp lệ
**3. Diff patch và đánh giá patching**

**4. Scan Wing FTP Server public và đánh giá bảo mật**

### Tổng quan về Pre OS Bootloading